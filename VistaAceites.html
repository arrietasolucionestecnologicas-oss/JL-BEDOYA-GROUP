<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lab. Aceites - Gestión Simplificada</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: system-ui, -apple-system, sans-serif; background-color: #f1f5f9; }
        .input-std { width: 100%; border: 1px solid #cbd5e1; border-radius: 8px; padding: 10px; outline: none; }
        .input-std:focus { border-color: #ca8a04; ring: 2px; }
        
        /* CLASE CLAVE PARA EL GRIS BAJITO */
        .row-delivered { background-color: #e5e7eb !important; color: #9ca3af !important; }
        .row-delivered td { border-bottom: 1px solid #d1d5db; }
        /* Botones desactivados visualmente si está entregado */
        .row-delivered button.action-btn { background-color: #9ca3af; pointer-events: auto; } 
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-6xl mx-auto mb-6 flex justify-between items-center">
        <div>
            <h1 class="text-2xl font-black text-slate-800">CONTROL DE ACEITES</h1>
            <p class="text-sm text-slate-500">Gestión de PCBs y Diagnóstico Básico</p>
        </div>
        <button onclick="cargarDatos()" class="bg-white p-2 rounded-full shadow hover:bg-slate-50">
            <i data-lucide="refresh-cw" class="w-5 h-5 text-slate-600"></i>
        </button>
    </div>

    <div class="max-w-6xl mx-auto bg-white p-4 rounded-xl shadow-sm border border-slate-200 mb-6 grid grid-cols-1 md:grid-cols-4 gap-4">
        <div>
            <label class="text-[10px] font-bold text-slate-500 uppercase">Buscar</label>
            <input type="text" id="filtro-buscar" onkeyup="aplicarFiltros()" placeholder="Cliente o ID..." class="input-std text-sm">
        </div>
        <div>
            <label class="text-[10px] font-bold text-slate-500 uppercase">Tipo de Servicio (Col G)</label>
            <select id="filtro-servicio" onchange="aplicarFiltros()" class="input-std text-sm bg-white">
                <option value="">-- Todos --</option>
                <option value="PROTOCOLO">Protocolo / Pruebas</option>
                <option value="MANTENIMIENTO">Mantenimiento</option>
                <option value="REGENERACION">Regeneración</option>
            </select>
        </div>
        <div>
            <label class="text-[10px] font-bold text-slate-500 uppercase">Estado PCB</label>
            <select id="filtro-pcb" onchange="aplicarFiltros()" class="input-std text-sm bg-white">
                <option value="">-- Todos --</option>
                <option value="Pendiente">Pendiente de PCB</option>
                <option value="Libre de PCB">Libre de PCB</option>
                <option value="Contaminado">Contaminado</option>
            </select>
        </div>
        <div>
            <label class="text-[10px] font-bold text-slate-500 uppercase">Estado Entrega</label>
            <select id="filtro-estado" onchange="aplicarFiltros()" class="input-std text-sm bg-white">
                <option value="PENDIENTE">Pendientes (En Planta)</option>
                <option value="ENTREGADO">Entregados (Histórico)</option>
                <option value="">Mostrar Todo</option>
            </select>
        </div>
    </div>

    <div class="max-w-6xl mx-auto bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
        <table class="w-full text-left border-collapse">
            <thead class="bg-slate-50 text-xs uppercase text-slate-500 font-bold border-b border-slate-200">
                <tr>
                    <th class="p-4">ID Entrada</th>
                    <th class="p-4">Cliente</th>
                    <th class="p-4">Servicio</th>
                    <th class="p-4">Estado Planta</th>
                    <th class="p-4">Estado PCB</th>
                    <th class="p-4 text-center">Acción</th>
                </tr>
            </thead>
            <tbody id="tabla-body" class="text-sm text-slate-700 divide-y divide-slate-100">
                <tr><td colspan="6" class="p-8 text-center text-slate-400">Cargando datos...</td></tr>
            </tbody>
        </table>
    </div>

    <div id="modal" class="fixed inset-0 bg-black/50 hidden flex items-center justify-center z-50 p-4 backdrop-blur-sm">
        <div class="bg-white w-full max-w-lg rounded-xl shadow-2xl overflow-hidden animate-up">
            <div class="bg-slate-50 p-4 border-b flex justify-between items-center">
                <h3 class="font-bold text-lg text-slate-800">Registro Laboratorio</h3>
                <button onclick="cerrarModal()" class="text-slate-400 hover:text-red-500"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>
            
            <form id="form-lab" class="p-6 space-y-4">
                <input type="hidden" id="in-id">
                <input type="hidden" id="in-cliente">
                
                <div class="bg-blue-50 p-3 rounded border border-blue-100 mb-4">
                    <p class="text-xs font-bold text-blue-800" id="info-trafo">ID: -- | Cliente: --</p>
                </div>

                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Estado de PCB</label>
                    <select id="in-pcb" class="input-std font-bold text-slate-700 bg-yellow-50 border-yellow-300">
                        <option value="Pendiente">⏳ Pendiente</option>
                        <option value="Libre de PCB">✅ Libre de PCB</option>
                        <option value="Contaminado">⛔ Contaminado</option>
                    </select>
                </div>

                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Observaciones PCB / Certificado</label>
                    <textarea id="in-obs-pcb" class="input-std h-20" placeholder="Ej: Certificado adjunto, Marcado como libre..."></textarea>
                </div>

                <hr class="border-slate-100 my-4">

                <div class="grid grid-cols-3 gap-3">
                    <div>
                        <label class="block text-[10px] font-bold text-slate-400 uppercase">Temp °C</label>
                        <input type="number" id="in-temp" class="input-std text-center">
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-slate-400 uppercase">Humedad %</label>
                        <input type="number" id="in-hum" class="input-std text-center">
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-slate-400 uppercase">Color</label>
                        <input type="text" id="in-color" class="input-std text-center">
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Conclusiones Generales</label>
                    <textarea id="in-concl" class="input-std h-20" placeholder="Estado general del equipo..."></textarea>
                </div>

                <div class="pt-2">
                    <button type="button" onclick="guardar()" id="btn-guardar" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg shadow transition-colors">
                        GUARDAR REGISTRO
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script src="app.js"></script>
    <script>
        let datosGlobales = [];

        // INICIO
        window.onload = function() {
            if(typeof lucide !== 'undefined') lucide.createIcons();
            cargarDatos();
        };

        function cargarDatos() {
            const tbody = document.getElementById('tabla-body');
            tbody.innerHTML = '<tr><td colspan="6" class="p-8 text-center text-slate-400">Consultando...</td></tr>';
            
            // Llamada al backend ESPECÍFICO de aceites
            google.script.run
                .withSuccessHandler(data => {
                    datosGlobales = data;
                    aplicarFiltros();
                })
                .withFailureHandler(err => {
                    tbody.innerHTML = `<tr><td colspan="6" class="p-4 text-red-500 text-center">Error: ${err}</td></tr>`;
                })
                .Aceites_ObtenerPendientes();
        }

        function aplicarFiltros() {
            const busqueda = document.getElementById('filtro-buscar').value.toLowerCase();
            const servicio = document.getElementById('filtro-servicio').value; // Mantenimiento, Protocolo...
            const pcb = document.getElementById('filtro-pcb').value;
            const estadoEntrega = document.getElementById('filtro-estado').value; // Pendiente, Entregado

            const filtrados = datosGlobales.filter(item => {
                // 1. Filtro Texto
                const matchTexto = (item.id + " " + item.cliente).toLowerCase().includes(busqueda);
                
                // 2. Filtro Servicio (Busca coincidencia parcial, ej: "PROTOCOLO" en "REPARACION PROTOCOLO")
                const matchServicio = servicio === "" || (item.tipoServicio && item.tipoServicio.includes(servicio));
                
                // 3. Filtro PCB (Coincidencia exacta)
                const matchPcb = pcb === "" || item.pcbEstado === pcb;

                // 4. Filtro Entrega (Basado en la Columna S que viene del Backend)
                const esEntregado = item.estadoProg && item.estadoProg.includes("ENTREGADO");
                let matchEntrega = true;
                if (estadoEntrega === "PENDIENTE" && esEntregado) matchEntrega = false;
                if (estadoEntrega === "ENTREGADO" && !esEntregado) matchEntrega = false;

                return matchTexto && matchServicio && matchPcb && matchEntrega;
            });

            renderizarTabla(filtrados);
        }

        function renderizarTabla(lista) {
            const tbody = document.getElementById('tabla-body');
            tbody.innerHTML = '';

            if (lista.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="p-8 text-center text-slate-400">No se encontraron registros.</td></tr>';
                return;
            }

            lista.forEach((item, index) => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-slate-50 transition-colors border-b border-slate-100";
                
                // LÓGICA VISUAL: GRIS BAJITO
                if (item.estadoProg && item.estadoProg.includes("ENTREGADO")) {
                    tr.classList.add('row-delivered');
                }

                // BADGE PCB
                let badgeClass = "bg-yellow-100 text-yellow-700 border-yellow-200";
                let pcbText = item.pcbEstado || "Pendiente";
                if (pcbText === "Libre de PCB") badgeClass = "bg-green-100 text-green-700 border-green-200";
                if (pcbText === "Contaminado") badgeClass = "bg-red-100 text-red-700 border-red-200";

                tr.innerHTML = `
                    <td class="p-4 font-mono font-bold text-slate-600">#${item.id}</td>
                    <td class="p-4 font-bold text-slate-800">${item.cliente}</td>
                    <td class="p-4 text-xs font-bold text-blue-600 bg-blue-50 rounded w-fit px-2 py-1">${item.tipoServicio || 'S/D'}</td>
                    <td class="p-4 text-xs text-slate-500">${item.estadoProg || 'En Proceso'}</td>
                    <td class="p-4"><span class="px-2 py-1 rounded text-[10px] font-black uppercase border ${badgeClass}">${pcbText}</span></td>
                    <td class="p-4 text-center">
                        <button onclick="abrirModal(${index})" class="action-btn bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-xs font-bold shadow transition-transform active:scale-95">
                            ${item.textoBoton}
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function abrirModal(index) {
            // Buscamos el item en la lista filtrada actual (Ojo: index debe referirse a la lista renderizada, pero aquí simplificamos buscando en globales por ID para seguridad)
            // Para simplificar en este ejemplo usaremos el objeto pasado directo si es posible, o re-buscamos.
            // Lo mejor es guardar referencia. Por ahora usaremos datosGlobales asumiendo que el orden visual coincide o pasando ID.
            // Corrección: Pasaremos el objeto directo en el onclick en una versión avanzada, aquí recuperamos del DOM o volvemos a filtrar.
            // Truco rápido: Filtramos de nuevo para hallar el objeto exacto, o pasamos el ID en el botón.
            // Voy a usar el ID del texto de la fila para buscar en datosGlobales.
            
            // MÉTODO ROBUSTO:
            const row = document.querySelectorAll('#tabla-body tr')[index];
            const idText = row.querySelector('td').innerText.replace('#','');
            const item = datosGlobales.find(x => x.id == idText);

            if(!item) return;

            document.getElementById('modal').classList.remove('hidden');
            document.getElementById('in-id').value = item.id;
            document.getElementById('in-cliente').value = item.cliente;
            document.getElementById('info-trafo').innerText = `ID: ${item.id} | ${item.cliente}`;

            // Llenar campos
            document.getElementById('in-pcb').value = item.pcbEstado || "Pendiente";
            document.getElementById('in-obs-pcb').value = item.obsPcb || "";
            document.getElementById('in-concl').value = item.conclusion || "";
            
            // Campos opcionales vacíos por defecto
            document.getElementById('in-temp').value = "";
            document.getElementById('in-hum').value = "";
            document.getElementById('in-color').value = "";
        }

        function cerrarModal() {
            document.getElementById('modal').classList.add('hidden');
        }

        function guardar() {
            const btn = document.getElementById('btn-guardar');
            btn.innerText = "GUARDANDO...";
            btn.disabled = true;

            const datos = {
                idTrafo: document.getElementById('in-id').value,
                cliente: document.getElementById('in-cliente').value,
                fechaMuestreo: new Date(), // Fecha actual automática
                tecnico: "LAB WEB",
                
                // Datos PCB
                pcbEstado: document.getElementById('in-pcb').value,
                obsPcb: document.getElementById('in-obs-pcb').value,
                conclusion: document.getElementById('in-concl').value,
                
                // Datos Fisicos (Opcionales)
                temp: document.getElementById('in-temp').value,
                humedad: document.getElementById('in-hum').value,
                color: document.getElementById('in-color').value,
                
                // Tipo Ensayo (Default)
                tipoEnsayo: "REPORTE WEB"
            };

            google.script.run
                .withSuccessHandler(res => {
                    btn.innerText = "GUARDAR REGISTRO";
                    btn.disabled = false;
                    if(res.exito) {
                        cerrarModal();
                        cargarDatos(); // Recargar tabla
                    } else {
                        alert("Error: " + res.error);
                    }
                })
                .Aceites_GuardarInforme(datos);
        }
    </script>
</body>
</html>
