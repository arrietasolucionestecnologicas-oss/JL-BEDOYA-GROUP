<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Laboratorio de Aceites | JLB</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    :root { --primary-color: #2c3e50; --accent-color: #3498db; --success-color: #27ae60; }
    body { background-color: #f8f9fa; font-family: 'Segoe UI', system-ui, sans-serif; }
    .header-bar { background: var(--primary-color); color: white; padding: 15px 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
    .card-trafo { border: none; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); transition: transform 0.2s; background: white; margin-bottom: 20px; border-left: 5px solid var(--accent-color); }
    .card-trafo:hover { transform: translateY(-3px); box-shadow: 0 8px 15px rgba(0,0,0,0.1); }
    .badge-status { font-size: 0.8em; padding: 5px 10px; border-radius: 20px; }
    .btn-action { border-radius: 20px; padding: 5px 20px; font-weight: 600; text-transform: uppercase; font-size: 0.85rem; width: 100%; }
    .tech-data { font-size: 0.9rem; color: #555; }
    .tech-data strong { color: #2c3e50; }
    .tech-row { display: flex; justify-content: space-between; border-bottom: 1px solid #eee; padding: 4px 0; }
    /* Estilos para el Historial */
    .history-card { border-left-color: #95a5a6; opacity: 0.9; }
    .history-card .btn-action { background-color: #95a5a6; border-color: #95a5a6; color: white; cursor: not-allowed; }
    /* Modal de Detalles */
    .modal-header { background: var(--primary-color); color: white; }
    .detail-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .detail-item { background: #f8f9fa; padding: 10px; border-radius: 8px; }
    .detail-label { font-size: 0.75rem; color: #7f8c8d; text-transform: uppercase; display: block; }
    .detail-value { font-weight: 600; color: #2c3e50; font-size: 1rem; }
  </style>
</head>
<body>

  <div class="header-bar d-flex justify-content-between align-items-center sticky-top">
    <div class="d-flex align-items-center">
      <i class="fas fa-flask fa-lg me-3"></i>
      <h4 class="m-0">Laboratorio de Aceites JLB</h4>
    </div>
    <div>
      <button class="btn btn-outline-light btn-sm" onclick="cargarDatos()"><i class="fas fa-sync-alt"></i> Actualizar</button>
    </div>
  </div>

  <div class="container">
    
    <ul class="nav nav-pills mb-4" id="pills-tab" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="pills-pendientes-tab" data-bs-toggle="pill" data-bs-target="#pills-pendientes" type="button" role="tab">
          <i class="fas fa-clock me-2"></i>Pendientes <span id="badge-pendientes" class="badge bg-danger rounded-pill ms-1">0</span>
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="pills-historial-tab" data-bs-toggle="pill" data-bs-target="#pills-historial" type="button" role="tab">
          <i class="fas fa-history me-2"></i>Historial Realizado
        </button>
      </li>
    </ul>

    <div class="tab-content" id="pills-tabContent">
      
      <div class="tab-pane fade show active" id="pills-pendientes" role="tabpanel">
        <div id="loader" class="text-center py-5">
          <div class="spinner-border text-primary" role="status"><span class="visually-hidden">Cargando...</span></div>
          <p class="mt-2 text-muted">Consultando Base de Datos Maestra...</p>
        </div>
        <div id="lista-pendientes" class="row"></div>
      </div>

      <div class="tab-pane fade" id="pills-historial" role="tabpanel">
        <div id="lista-historial" class="row"></div>
      </div>

    </div>
  </div>

  <div class="modal fade" id="modalAnalisis" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="fas fa-microscope me-2"></i>Registro de Análisis de Laboratorio</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          
          <div class="card mb-4 border-info">
            <div class="card-header bg-info text-white">
              <i class="fas fa-info-circle me-2"></i>Hoja de Vida Técnica (BD Externa)
            </div>
            <div class="card-body bg-light">
              <div class="detail-grid">
                <div class="detail-item"><span class="detail-label">ID Transformador</span><span class="detail-value" id="m-id"></span></div>
                <div class="detail-item"><span class="detail-label">Cliente</span><span class="detail-value" id="m-cliente"></span></div>
                <div class="detail-item"><span class="detail-label">Potencia (KVA)</span><span class="detail-value text-primary" id="m-kva"></span></div>
                <div class="detail-item"><span class="detail-label">Marca</span><span class="detail-value" id="m-marca"></span></div>
                
                <div class="detail-item"><span class="detail-label">Tensión Primaria</span><span class="detail-value" id="m-vp"></span></div>
                <div class="detail-item"><span class="detail-label">Tensión Secundaria</span><span class="detail-value" id="m-vs"></span></div>
                <div class="detail-item"><span class="detail-label">Número de Fases</span><span class="detail-value" id="m-fases"></span></div>
                <div class="detail-item"><span class="detail-label">Grupo Conexión</span><span class="detail-value" id="m-grupo"></span></div>
                
                <div class="detail-item"><span class="detail-label">Vol. Aceite (Litros)</span><span class="detail-value text-danger" id="m-litros"></span></div>
                <div class="detail-item"><span class="detail-label">Peso Total</span><span class="detail-value" id="m-peso"></span></div>
                <div class="detail-item"><span class="detail-label">Año Fabricación</span><span class="detail-value" id="m-anio"></span></div>
                <div class="detail-item"><span class="detail-label">Tipo (Seco/Aceite)</span><span class="detail-value" id="m-tipo"></span></div>
                
                <div class="detail-item"><span class="detail-label">N° Serie</span><span class="detail-value" id="m-serie"></span></div>
                <div class="detail-item"><span class="detail-label">Taps / Derivaciones</span><span class="detail-value" id="m-taps"></span></div>
              </div>
            </div>
          </div>

          <form id="formAnalisis">
            <input type="hidden" id="f-id">
            <input type="hidden" id="f-cliente">
            <input type="hidden" id="f-tipoEnsayo">

            <div class="mb-3">
              <label class="form-label fw-bold">Responsable del Análisis</label>
              <input type="text" class="form-control" id="f-responsable" required placeholder="Nombre del químico/técnico">
            </div>

            <div class="mb-3">
              <label class="form-label fw-bold">Fecha de Ejecución</label>
              <input type="date" class="form-control" id="f-fecha" required>
            </div>

            <div class="mb-3">
              <label class="form-label fw-bold">Conclusión / Resultado</label>
              <select class="form-select" id="f-conclusion" required>
                <option value="APROBADO">✅ APROBADO (Cumple Normativa)</option>
                <option value="RECHAZADO">❌ RECHAZADO (Requiere Tratamiento)</option>
                <option value="OBSERVACION">⚠️ CON OBSERVACIONES</option>
              </select>
            </div>

            <div class="alert alert-warning d-flex align-items-center" role="alert">
              <i class="fas fa-exclamation-triangle me-2"></i>
              <div>
                Al guardar, se actualizará el estado en Programación y el equipo avanzará de etapa.
              </div>
            </div>

          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-success" onclick="guardarInforme()">
            <i class="fas fa-save me-2"></i>Guardar y Finalizar
          </button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <script>
    let DATA_PENDIENTE = [];
    let DATA_HISTORIAL = [];

    // INICIO
    document.addEventListener('DOMContentLoaded', function() {
      cargarDatos();
      // Set fecha hoy por defecto
      document.getElementById('f-fecha').valueAsDate = new Date();
    });

    function cargarDatos() {
      document.getElementById('loader').style.display = 'block';
      document.getElementById('lista-pendientes').innerHTML = '';
      document.getElementById('lista-historial').innerHTML = '';

      google.script.run
        .withSuccessHandler(procesarDatos)
        .withFailureHandler(error => {
           Swal.fire('Error', 'No se pudo conectar con el servidor: ' + error, 'error');
           document.getElementById('loader').style.display = 'none';
        })
        .Aceites_ObtenerPendientes();
    }

    function procesarDatos(data) {
      document.getElementById('loader').style.display = 'none';
      
      DATA_PENDIENTE = data.filter(d => d.status === 'PENDIENTE');
      DATA_HISTORIAL = data.filter(d => d.status === 'REALIZADO');

      // Actualizar Badges
      document.getElementById('badge-pendientes').textContent = DATA_PENDIENTE.length;

      renderizarTarjetas(DATA_PENDIENTE, 'lista-pendientes', true);
      renderizarTarjetas(DATA_HISTORIAL, 'lista-historial', false);
    }

    function renderizarTarjetas(lista, contenedorId, esPendiente) {
      const contenedor = document.getElementById(contenedorId);
      
      if (lista.length === 0) {
        contenedor.innerHTML = `<div class="col-12 text-center text-muted mt-4">
            <i class="fas fa-folder-open fa-3x mb-3"></i><br>No hay registros en esta sección.
        </div>`;
        return;
      }

      let html = '';
      lista.forEach(item => {
        // Validación de datos técnicos para mostrar "-" si vienen vacíos
        const kva = (item.info && item.info.kva) ? item.info.kva : '?';
        const marca = (item.info && item.info.marca) ? item.info.marca : '-';
        const serie = (item.info && item.info.serie) ? item.info.serie : '-';
        const vp = (item.info && item.info.vp) ? item.info.vp : '-';
        const vs = (item.info && item.info.vs) ? item.info.vs : '-';

        // Estilos según acción
        let btnClass = "btn-primary";
        let cardBorder = "";
        if (item.accion === "PCB") { btnClass = "btn-warning text-dark"; cardBorder = "border-warning"; }
        if (item.accion === "FINAL") { btnClass = "btn-success"; cardBorder = "border-success"; }

        // Si es historial, deshabilitar
        const btnState = esPendiente ? `onclick="abrirModal('${item.id}')"` : "disabled";
        const cssHist = !esPendiente ? "history-card" : "";

        html += `
        <div class="col-md-6 col-lg-4">
          <div class="card card-trafo p-3 ${cssHist} ${cardBorder}">
            <div class="d-flex justify-content-between align-items-start mb-2">
              <h5 class="fw-bold text-primary m-0">ID: ${item.id}</h5>
              <span class="badge bg-secondary">${item.fechaIngreso}</span>
            </div>
            
            <p class="mb-1 text-truncate fw-bold"><i class="fas fa-building me-1 text-muted"></i> ${item.cliente}</p>
            <p class="mb-2 text-muted small"><i class="fas fa-tools me-1"></i> ${item.servicio}</p>
            
            <div class="bg-light p-2 rounded mb-3 tech-data">
                <div class="tech-row"><span>KVA:</span> <strong>${kva}</strong></div>
                <div class="tech-row"><span>Marca:</span> <strong>${marca}</strong></div>
                <div class="tech-row"><span>Serie:</span> <strong>${serie}</strong></div>
                <div class="tech-row"><span>Tensión:</span> <strong>${vp} / ${vs}</strong></div>
            </div>

            <button class="btn ${btnClass} btn-action" ${btnState}>
              ${esPendiente ? '<i class="fas fa-edit me-1"></i>' : '<i class="fas fa-check-circle me-1"></i>'} 
              ${item.textoBoton}
            </button>
          </div>
        </div>
        `;
      });
      contenedor.innerHTML = html;
    }

    // ABRIR MODAL CON DATOS COMPLETOS
    function abrirModal(id) {
      const item = DATA_PENDIENTE.find(d => String(d.id) === String(id));
      if(!item) return;

      // Llenar Ficha Técnica (Hoja de Vida)
      document.getElementById('m-id').textContent = item.id;
      document.getElementById('m-cliente').textContent = item.cliente;
      document.getElementById('m-kva').textContent = item.info.kva || "-";
      document.getElementById('m-marca').textContent = item.info.marca || "-";
      document.getElementById('m-serie').textContent = item.info.serie || "-";
      
      document.getElementById('m-vp').textContent = item.info.vp || "-";
      document.getElementById('m-vs').textContent = item.info.vs || "-";
      document.getElementById('m-fases').textContent = item.info.fases || "-";
      document.getElementById('m-grupo').textContent = item.info.grupo || "-";
      
      document.getElementById('m-peso').textContent = item.info.peso || "-";
      document.getElementById('m-litros').textContent = item.info.litros || "-";
      document.getElementById('m-anio').textContent = item.info.anio || "-";
      document.getElementById('m-tipo').textContent = item.info.tipo_trafo || "-";
      document.getElementById('m-taps').textContent = item.info.taps || "-";

      // Preparar Formulario
      document.getElementById('f-id').value = item.id;
      document.getElementById('f-cliente').value = item.cliente;
      document.getElementById('f-tipoEnsayo').value = item.accion; // PCB, FINAL, PARCIAL...
      
      var modal = new bootstrap.Modal(document.getElementById('modalAnalisis'));
      modal.show();
    }

    // GUARDAR
    function guardarInforme() {
      const responsable = document.getElementById('f-responsable').value;
      if (!responsable) { Swal.fire('Atención', 'Debe indicar el responsable.', 'warning'); return; }

      const payload = {
        idTrafo: document.getElementById('f-id').value,
        cliente: document.getElementById('f-cliente').value,
        fecha: document.getElementById('f-fecha').value,
        responsable: responsable,
        conclusion: document.getElementById('f-conclusion').value,
        tipoEnsayo: document.getElementById('f-tipoEnsayo').value
      };

      // Loading visual
      const btn = document.querySelector('#modalAnalisis .btn-success');
      const originalText = btn.innerHTML;
      btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Guardando...';
      btn.disabled = true;

      google.script.run
        .withSuccessHandler(res => {
          if (res.exito) {
            Swal.fire('Guardado', 'El análisis se registró correctamente.', 'success');
            bootstrap.Modal.getInstance(document.getElementById('modalAnalisis')).hide();
            cargarDatos(); // Recargar lista
          } else {
            Swal.fire('Error', res.error, 'error');
          }
          btn.innerHTML = originalText;
          btn.disabled = false;
        })
        .withFailureHandler(err => {
          Swal.fire('Error de Red', err.message, 'error');
          btn.innerHTML = originalText;
          btn.disabled = false;
        })
        .Aceites_GuardarInforme(payload);
    }
  </script>
</body>
</html>
