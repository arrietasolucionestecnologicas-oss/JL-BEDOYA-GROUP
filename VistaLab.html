<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Laboratorio JLB</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; color: #334155; min-height: 100vh; overflow-y: auto; }
        #loader { position: fixed; inset: 0; background: rgba(255, 255, 255, 0.98); z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; transition: opacity 0.3s ease; }
        .card-lab { background: white; border: 1px solid #e2e8f0; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.02); margin-bottom: 16px; overflow: hidden; }
        .card-header { padding: 14px 16px; border-bottom: 1px solid #f1f5f9; display: flex; justify-content: space-between; align-items: flex-start; }
        .btn-action { display: flex; align-items: center; justify-content: space-between; padding: 8px 12px; border-radius: 6px; font-size: 11px; font-weight: 600; cursor: pointer; border: 1px solid transparent; transition: all 0.1s; background: #f8fafc; color: #64748b; border-color: #e2e8f0; }
        .btn-action:active { transform: scale(0.97); }
        .st-pendiente { background: #fff7ed; color: #c2410c; border-color: #ffedd5; } 
        .st-listo { background: #f0fdf4; color: #15803d; border-color: #bbf7d0; } 
        .st-na { background: #f1f5f9; color: #94a3b8; border-color: #e2e8f0; opacity: 0.6; } 
        .sticky-top { position: sticky; top: 0; z-index: 50; background: rgba(248, 250, 252, 0.95); backdrop-filter: blur(5px); border-bottom: 1px solid #e2e8f0; }
    </style>
</head>
<body>

    <div id="loader">
        <div class="animate-spin rounded-full h-10 w-10 border-4 border-blue-600 border-t-transparent mb-4"></div>
        <div class="text-slate-500 font-bold text-xs tracking-widest">CARGANDO DATOS...</div>
    </div>

    <header class="bg-white border-b border-slate-200 px-6 py-4 flex justify-between items-center shadow-sm sticky top-0 z-50">
        <div class="flex items-center gap-3">
            <div class="bg-blue-600 text-white p-2 rounded-lg"><i data-lucide="flask-conical" class="w-5 h-5"></i></div>
            <div>
                <h1 class="font-bold text-lg text-slate-800 leading-none">Laboratorio</h1>
                <p class="text-[11px] text-slate-500 mt-1">Gestión de Calidad</p>
            </div>
        </div>
        <button onclick="location.reload()" class="bg-slate-50 hover:bg-slate-100 text-slate-700 px-4 py-2 rounded-lg font-bold text-xs flex items-center gap-2 border border-slate-200 transition-colors">
            <i data-lucide="refresh-cw" class="w-4 h-4 text-blue-600"></i> ACTUALIZAR
        </button>
    </header>

    <main class="max-w-7xl mx-auto p-4 md:p-6 grid grid-cols-1 md:grid-cols-2 gap-6">
        <section>
            <div class="sticky-top py-3 mb-4 flex items-center gap-2 text-blue-700 font-bold text-sm uppercase border-b-2 border-blue-100">
                <i data-lucide="log-in" class="w-4 h-4"></i> Ingresos (Pruebas Iniciales)
            </div>
            <div id="col-inicial" class="space-y-4 pb-10"></div>
        </section>

        <section>
            <div class="sticky-top py-3 mb-4 flex items-center gap-2 text-green-700 font-bold text-sm uppercase border-b-2 border-green-100">
                <i data-lucide="log-out" class="w-4 h-4"></i> Salidas (Pruebas Finales)
            </div>
            <div id="col-final" class="space-y-4 pb-10"></div>
        </section>
    </main>

    <script src="app.js"></script>

    <script>
        // --- AUTO-DESTRUCCIÓN LOADER ---
        setTimeout(() => {
            const l = document.getElementById('loader');
            if(l && l.style.display !== 'none') {
                console.warn("Forzando apertura...");
                l.style.opacity = '0';
                setTimeout(() => l.style.display = 'none', 500);
            }
        }, 5000);

        window.onload = function() {
            if(typeof lucide !== 'undefined') lucide.createIcons();
            cargarDatos();
        };

        function cargarDatos() {
            // AHORA USAMOS LA LLAMADA DIRECTA GRACIAS A APP.JS
            google.script.run
                .withSuccessHandler(render)
                .withFailureHandler(err => { alert("Error: " + err); ocultarLoader(); })
                .Lab_ObtenerDatos(); // Llamada directa, sin API_Handler
        }

        function ocultarLoader() {
            const l = document.getElementById('loader');
            l.style.opacity = '0';
            setTimeout(() => l.style.display = 'none', 300);
        }

        function render(res) {
            // App.js ya devuelve el objeto JSON parseado (res.data o res directo)
            // Ajustamos según lo que devuelve tu backend
            const list = Array.isArray(res) ? res : (res.data || []); 
            
            const c1 = document.getElementById('col-inicial');
            const c2 = document.getElementById('col-final');
            c1.innerHTML = ''; c2.innerHTML = '';

            if(list.length === 0) {
                c1.innerHTML = '<div class="text-center p-10 text-slate-400">No hay datos pendientes.</div>';
                ocultarLoader();
                return;
            }

            list.forEach(item => {
                const html = cardHTML(item);
                if(item.etapa === 'INICIAL') c1.insertAdjacentHTML('beforeend', html);
                else c2.insertAdjacentHTML('beforeend', html);
            });

            if(typeof lucide !== 'undefined') lucide.createIcons();
            ocultarLoader();
        }

        function cardHTML(i) {
            const st = (k) => i[k] || 'PENDIENTE';
            const cls = (s) => s==='LISTO'?'st-listo':(s==='N/A'?'st-na':'st-pendiente');
            const ico = (s) => s==='LISTO'?'check-circle-2':(s==='N/A'?'slash':'circle');

            const btns = i.etapa === 'FINAL' 
                ? [['p_fin','P. Finales'], ['ac_fin','Aceite Fin'], ['proto','Protocolo']]
                : [['p_ini','P. Iniciales'], ['insp','Inspección'], ['ac_ini','Aceite Ini']];

            let htmlBtns = '';
            btns.forEach(b => {
                const s = st(b[0]);
                htmlBtns += `
                    <div onclick="cambiar('${i.id}','${b[0]}',this)" class="btn-action ${cls(s)}">
                        <span>${b[1]}</span> <i data-lucide="${ico(s)}" class="w-4 h-4"></i>
                    </div>`;
            });

            const sO = st('otros');
            htmlBtns += `
                <div onclick="cambiar('${i.id}','otros',this)" class="btn-action ${cls(sO)} col-span-3 justify-center gap-2 mt-1">
                    <span>OTROS PROCESOS / TALLER</span> <i data-lucide="${ico(sO)}" class="w-4 h-4"></i>
                </div>`;

            return `
                <div class="card-lab">
                    <div class="card-header">
                        <div>
                            <div class="flex items-center gap-2 mb-1">
                                <span class="bg-slate-100 text-slate-500 text-[10px] font-bold px-2 py-0.5 rounded border border-slate-200">#${i.id}</span>
                                <span class="text-xs text-slate-400 font-mono">${i.fecha?i.fecha.substring(0,10):''}</span>
                            </div>
                            <h3 class="font-bold text-slate-800 text-sm leading-tight">${i.cliente || 'Sin Cliente'}</h3>
                            <p class="text-xs text-slate-500 mt-1 truncate w-64">${i.desc || '...'}</p>
                        </div>
                    </div>
                    <div class="p-3 bg-white grid grid-cols-3 gap-2">
                        ${htmlBtns}
                    </div>
                </div>
            `;
        }

        function cambiar(id, col, btn) {
            btn.style.opacity = '0.5';
            // Llamada directa usando el nuevo app.js
            google.script.run.withSuccessHandler(res => {
                if(res.exito || res.status === 'success') {
                    const s = res.nuevoEstado;
                    const ico = s==='LISTO'?'check-circle-2':(s==='N/A'?'slash':'circle');
                    let baseCls = "btn-action " + (s==='LISTO'?'st-listo':(s==='N/A'?'st-na':'st-pendiente'));
                    if(col==='otros') baseCls += " col-span-3 justify-center gap-2 mt-1";
                    
                    btn.className = baseCls;
                    const span = btn.querySelector('span');
                    btn.innerHTML = ''; 
                    if(span) btn.appendChild(span);
                    btn.innerHTML += ` <i data-lucide="${ico}" class="w-4 h-4"></i>`;
                    if(typeof lucide !== 'undefined') lucide.createIcons();
                    btn.style.opacity = '1';
                } else { 
                    alert("Error al actualizar"); btn.style.opacity = '1'; 
                }
            }).Lab_CambiarEstado(id, col); // Pasamos los argumentos directos
        }
    </script>
</body>
</html>
