<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <title>Sistema T√©cnico - JL BEDOYA</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  
  <style>
    :root { --primary: #0d6efd; --sidebar-w: 260px; }
    body { background-color: #f4f6f8; font-family: 'Segoe UI', Roboto, sans-serif; padding-bottom: 80px; font-size: 0.9rem; }
    .sidebar { width: var(--sidebar-w); height: 100vh; position: fixed; top: 0; left: 0; background: #fff; border-right: 1px solid #dee2e6; z-index: 1000; transition: 0.3s; }
    .nav-link { color: #555; padding: 15px 20px; display: flex; align-items: center; border-radius: 0 25px 25px 0; margin-bottom: 5px; cursor: pointer; text-decoration: none; }
    .nav-link.active { background: #e3f2fd; color: var(--primary); font-weight: bold; border-right: 3px solid var(--primary); }
    .main { margin-left: var(--sidebar-w); padding: 20px; transition: 0.3s; }
    .view { display: none; animation: fadeIn 0.3s; }
    .view.active { display: block; }
    @keyframes fadeIn { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }
    .mobile-header { display: none; }
    @media (max-width: 768px) {
      .sidebar { transform: translateX(-100%); }
      .sidebar.open { transform: translateX(0); box-shadow: 5px 0 15px rgba(0,0,0,0.1); }
      .main { margin-left: 0; padding: 15px; }
      .mobile-header { display: flex; justify-content: space-between; align-items: center; padding: 15px; background: #fff; position: sticky; top: 0; z-index: 900; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 15px; }
      .overlay { position: fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); z-index:999; display:none; }
      .overlay.show { display:block; }
    }
    .card { border:none; border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,0.03); margin-bottom:15px; background: white; }
    .agenda-card { border-left: 4px solid var(--primary); transition: transform 0.2s; cursor: pointer; }
    .badge-jlb { background-color: #0d6efd; color: white; }
    .badge-group { background-color: #fd7e14; color: white; }
    .bg-purple { background-color: #6f42c1 !important; color: white; }
    .blink { animation: blinker 1.5s linear infinite; }
    @keyframes blinker { 50% { opacity: 0.5; } }
    .link-entrada { color: var(--primary); font-weight: bold; cursor: pointer; }
  </style>
</head>
<body>

  <div class="mobile-header">
    <button class="btn btn-light text-primary" onclick="toggleMenu()"><i class="fas fa-bars fa-lg"></i></button>
    <span class="fw-bold">JL BEDOYA</span>
    <button class="btn btn-light" onclick="location.reload()"><i class="fas fa-sync"></i></button>
  </div>
  <div class="overlay" onclick="toggleMenu()"></div>

  <div class="sidebar" id="sidebar">
    <div class="p-3 border-bottom"><h5 class="text-primary fw-bold m-0">SISTEMA T√âCNICO</h5><small class="text-muted">V33.0 | Fix ID & Serie</small></div>
    <div class="mt-4">
      <div class="nav-link active" onclick="nav('home', this)"><i class="fas fa-home me-2"></i> Inicio</div>
      <div class="small text-muted fw-bold px-3 mt-3 mb-2">M√ìDULOS</div>
      <div class="nav-link" onclick="nav('hv', this)"><i class="fas fa-edit me-2"></i> Hoja de Vida</div>
      <div class="nav-link" onclick="nav('insp', this)"><i class="fas fa-clipboard-check me-2"></i> Inspecci√≥n</div>
      <div class="nav-link" onclick="nav('curva', this)"><i class="fas fa-temperature-high me-2"></i> Secamiento</div>
      <div class="nav-link" onclick="nav('ini', this)"><i class="fas fa-flask me-2"></i> P. Iniciales</div>
      <div class="nav-link" onclick="nav('fin', this)"><i class="fas fa-check-circle me-2"></i> P. Finales</div>
      <div class="nav-link" onclick="nav('hist', this)"><i class="fas fa-history me-2"></i> Historial</div>
    </div>
  </div>

  <div class="main">
    <div id="view-home" class="view active">
      <div class="text-center py-5">
        <h3 class="fw-bold text-dark mb-4">Panel de Control</h3>
        <button onclick="abrirAgenda()" class="btn btn-primary btn-lg fw-bold shadow-sm w-100 py-3 mb-4" style="max-width: 400px;">
            <i class="fas fa-cloud-download-alt me-2"></i> SINCRONIZAR AGENDA
        </button>
      </div>
    </div>

    <div id="view-hv" class="view">
        <h4 class="mb-3 fw-bold text-dark"><i class="fas fa-edit me-2"></i>Hoja de Vida</h4>
        <div class="card p-3 mb-3"><div class="input-group"><input type="number" id="search_hv" class="form-control fw-bold" placeholder="Entrada..."><button class="btn btn-dark" onclick="buscar('hv')">Buscar</button></div></div>
        <div id="form_hv" class="d-none">
            <div class="card p-4"><h6 class="text-muted">DATOS CARGADOS...</h6></div>
        </div>
    </div>

    <div id="view-insp" class="view"><h4 class="text-success">Inspecci√≥n</h4><div class="card p-3"><div class="input-group"><input type="number" id="search_insp" class="form-control" placeholder="Entrada..."><button class="btn btn-success" onclick="buscar('insp')">Validar</button></div></div><div id="form_insp" class="d-none"></div></div>
    <div id="view-curva" class="view"><h4 class="text-danger">Secamiento</h4><div class="card p-3"><div class="input-group"><input type="number" id="search_curva" class="form-control" placeholder="Entrada..."><button class="btn btn-danger" onclick="buscar('curva')">Cargar</button></div></div><div id="panel_curva" class="d-none"></div></div>
    <div id="view-hist" class="view"><h4 class="text-info">Historial</h4><div class="card p-3 mb-3"><input type="text" id="filtroHistorial" class="form-control" placeholder="Buscar..." onkeyup="filtrarHistorial()"></div><div class="card p-0"><table class="table table-hover mb-0 text-center"><tbody id="tabla_historial_body"></tbody></table></div></div>
    <div id="template-lab"></div>

  </div> 

  <div class="modal fade" id="modalAgenda" tabindex="-1">
    <div class="modal-dialog modal-fullscreen-sm-down modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white"><h5 class="modal-title fw-bold">AGENDA PENDIENTE</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
            <div class="modal-body bg-light">
                <div class="row g-2 mb-3">
                    <div class="col-md-6"><input type="text" id="filtroAgenda" class="form-control" placeholder="Buscar..." onkeyup="filtrarAgenda()"></div>
                    <div class="col-md-6">
                        <select id="filtroEstadoAgenda" class="form-select fw-bold text-primary" onchange="filtrarAgenda()">
                            <option value="TODOS">‚ö° TODOS</option>
                            <option value="warning">‚ö†Ô∏è INICIALES</option>
                            <option value="primary">üîµ FINALES</option>
                        </select>
                    </div>
                </div>
                <div id="listaAgendaContainer"><div class="text-center py-5 text-muted">Cargando...</div></div>
            </div>
        </div>
    </div>
  </div>

  <div class="modal fade" id="modalCrear" tabindex="-1">
    <div class="modal-dialog modal-fullscreen-sm-down modal-lg">
      <div class="modal-content">
        <div class="modal-header bg-warning"><h5 class="modal-title fw-bold">CREAR HOJA DE VIDA</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body bg-light">
          <div class="row g-2">
            <div class="col-md-4 col-6"><label class="small text-muted">ENTRADA</label><input id="new_entrada" class="form-control fw-bold" readonly></div>
            <div class="col-md-4 col-6"><label class="small text-muted">KVA</label><input id="new_kva" type="number" class="form-control"></div>
            <div class="col-md-4 col-12"><label class="small text-muted">CLIENTE</label><input id="new_cliente" class="form-control"></div>
            <div class="col-md-6 col-12"><label class="small text-muted">SERIE</label><input id="new_serie" class="form-control"></div> <div class="col-md-6 col-12"><label class="small text-muted">MARCA</label><input id="new_marca" class="form-control"></div>
            <div class="col-md-3 col-6"><label class="small text-muted">V.PRIM</label><input id="new_vp" type="number" class="form-control"></div>
            <div class="col-md-3 col-6"><label class="small text-muted">V.SEC</label><input id="new_vs" type="number" class="form-control"></div>
            <div class="col-md-3 col-6"><label class="small text-muted">FASES</label><select id="new_fases" class="form-select"><option value="3">3</option><option value="1">1</option></select></div>
            <div class="col-md-3 col-6"><label class="small text-muted">GRUPO</label><input id="new_grupo" class="form-control"></div>
          </div>
        </div>
        <div class="modal-footer"><button type="button" class="btn btn-warning fw-bold" onclick="crearHoja()">GUARDAR</button></div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const URL_API_CAMPO = "https://script.google.com/macros/s/AKfycbzdW332Skk5Po7SHLzOddgzLe2Am3WyPpQ6B9bYJI08Nz9sk8kAmWAX28HvAv3BFk-15A/exec";
    
    // --- VARIABLES GLOBALES ---
    let AGENDA_CACHE = [];
    let ITEM_SELECCIONADO = null; // Guardar√° el objeto completo del equipo seleccionado
    let modalCrear, modalAgenda;

    // --- CONECTOR GOOGLE ---
    const runGoogle = (func, payload = {}) => {
        return new Promise((resolve, reject) => {
            fetch(URL_API_CAMPO, { method: 'POST', body: JSON.stringify({ action: func, payload: payload }) })
            .then(r => r.json())
            .then(data => data.error ? reject(data.error) : resolve(data))
            .catch(err => reject(err));
        });
    };

    document.addEventListener('DOMContentLoaded', () => {
        try {
            modalCrear = new bootstrap.Modal(document.getElementById('modalCrear'));
            modalAgenda = new bootstrap.Modal(document.getElementById('modalAgenda'));
            // Cargar vistas din√°micas (Lab) si es necesario...
        } catch(e) { console.error("Init error", e); }
    });

    // --- AGENDA & SELECCI√ìN (FIX CR√çTICO) ---
    function abrirAgenda() {
        modalAgenda.show();
        document.getElementById('listaAgendaContainer').innerHTML = '<div class="text-center py-5"><div class="spinner-border text-primary"></div></div>';
        
        runGoogle('obtenerDatosProgramacion').then(res => {
            AGENDA_CACHE = res.data || [];
            renderAgenda(AGENDA_CACHE);
        }).catch(err => {
            document.getElementById('listaAgendaContainer').innerHTML = `<div class="alert alert-danger">${err}</div>`;
        });
    }

    function renderAgenda(lista) {
        const c = document.getElementById('listaAgendaContainer'); c.innerHTML = '';
        if(lista.length === 0) { c.innerHTML = '<div class="text-center text-muted">Sin pendientes.</div>'; return; }
        
        lista.forEach(item => {
            // USAMOS EL ID COMO CLAVE √öNICA EN EL ONCLICK
            let html = `
            <div class="card agenda-card mb-3 p-3" onclick="seleccionarEquipo('${item.id}')">
                <div class="d-flex justify-content-between">
                    <div>
                        <span class="badge bg-primary mb-1">#${item.id}</span>
                        <span class="badge bg-${item.colorTecnico} mb-1 ms-2 blink">${item.estadoTecnico}</span>
                        <h6 class="fw-bold mb-0">${item.cliente}</h6>
                        <small class="text-muted">${item.descripcion}</small>
                    </div>
                    <button class="btn btn-outline-primary btn-sm rounded-pill"><i class="fas fa-arrow-right"></i></button>
                </div>
            </div>`;
            c.insertAdjacentHTML('beforeend', html);
        });
    }

    function filtrarAgenda() {
        const q = document.getElementById('filtroAgenda').value.toLowerCase();
        const filtrados = AGENDA_CACHE.filter(i => 
            i.cliente.toLowerCase().includes(q) || i.id.toString().includes(q)
        );
        renderAgenda(filtrados);
    }

    // --- FUNCI√ìN CLAVE: SELECCIONAR Y BUSCAR ---
    function seleccionarEquipo(id) {
        // 1. Buscamos el objeto completo en la cach√© usando el ID √∫nico
        ITEM_SELECCIONADO = AGENDA_CACHE.find(i => String(i.id) === String(id));
        
        if (ITEM_SELECCIONADO) {
            modalAgenda.hide();
            // Llenamos el buscador de Inspecci√≥n (o cualquier otro)
            const inputInsp = document.getElementById('search_insp');
            if(inputInsp) {
                inputInsp.value = ITEM_SELECCIONADO.id;
                buscar('insp'); // Ejecutamos la b√∫squeda autom√°ticamente
            }
        }
    }

    // --- FUNCI√ìN BUSCAR CON AUTO-LLENADO ---
    function buscar(mod) {
        const inputId = 'search_' + mod;
        const val = document.getElementById(inputId).value;
        if(!val) return Swal.fire('Error', 'Ingrese Entrada', 'warning');

        // Mostrar loading...
        runGoogle('buscarInfoEntrada', {entrada: val}).then(res => {
            if (res.found) {
                // Si existe, mostramos los datos (L√≥gica normal)
                document.getElementById('form_' + mod).classList.remove('d-none');
                // ... (Llenar campos existentes) ...
            } else {
                // SI NO EXISTE -> OFRECER CREAR CON AUTO-LLENADO
                Swal.fire({
                    title: 'No existe',
                    text: `La entrada ${val} no tiene Hoja de Vida. ¬øCrearla ahora?`,
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: 'S√≠, Crear'
                }).then(r => {
                    if (r.isConfirmed) {
                        document.getElementById('new_entrada').value = val;
                        
                        // AQU√ç OCURRE LA MAGIA DEL PRE-LLENADO
                        // Si venimos de la agenda y el ID coincide, usamos esos datos
                        if (ITEM_SELECCIONADO && String(ITEM_SELECCIONADO.id) === String(val)) {
                            document.getElementById('new_cliente').value = ITEM_SELECCIONADO.cliente || "";
                            document.getElementById('new_serie').value = ITEM_SELECCIONADO.serie || ""; // ¬°AHORA S√ç LLEGAR√Å!
                            
                            // Extraer KVA de la descripci√≥n si es posible
                            const desc = ITEM_SELECCIONADO.descripcion || "";
                            const match = desc.match(/(\d+(\.\d+)?)\s*KVA/i);
                            if (match) document.getElementById('new_kva').value = match[1];
                        }
                        
                        modalCrear.show();
                    }
                });
            }
        }).catch(err => Swal.fire('Error', err, 'error'));
    }

    // --- CREAR HOJA (Backend Call) ---
    function crearHoja() {
        const d = {
            entrada: document.getElementById('new_entrada').value,
            cliente: document.getElementById('new_cliente').value,
            kva: document.getElementById('new_kva').value,
            serie: document.getElementById('new_serie').value,
            marca: document.getElementById('new_marca').value,
            // ... resto de campos ...
        };
        
        if(!d.cliente || !d.kva) return Swal.fire('Faltan Datos', 'Cliente y KVA son obligatorios', 'warning');
        
        runGoogle('registrarNuevaEntrada', d).then(res => {
            if(res.success) {
                modalCrear.hide();
                Swal.fire('Creado', 'Hoja de vida registrada', 'success');
                // Recargar b√∫squeda
                buscar('insp'); 
            } else {
                Swal.fire('Error', res.error, 'error');
            }
        });
    }

    // Funciones de navegaci√≥n y toggle (Standard)
    function toggleMenu() { document.getElementById('sidebar').classList.toggle('open'); document.querySelector('.overlay').classList.toggle('show'); }
    function nav(viewId, btn) {
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.getElementById('view-' + viewId).classList.add('active');
        // ... (resto de l√≥gica de navegaci√≥n)
        if(viewId === 'hist') cargarHistorial();
    }
    
    // Historial Logic (Simplificado para el ejemplo)
    function cargarHistorial() {
        runGoogle('obtenerHistorialGeneral').then(res => {
            // Render table...
        });
    }

  </script>
</body>
</html>
