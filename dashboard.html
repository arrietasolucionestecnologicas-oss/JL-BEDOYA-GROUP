<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Gerencial | JLB</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #e2e8f0; }
        .card { background: #1e293b; border: 1px solid #334155; border-radius: 12px; padding: 20px; cursor: pointer; transition: all 0.2s; position: relative; overflow: hidden; }
        .card:hover { transform: translateY(-4px); border-color: #94a3b8; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3); }
        .card::after { content: "VER DETALLE →"; position: absolute; bottom: 10px; right: 20px; font-size: 10px; font-weight: bold; opacity: 0; transition: opacity 0.2s; }
        .card:hover::after { opacity: 1; }
        .stat-val { font-size: 2.5rem; font-weight: 800; line-height: 1; margin-bottom: 5px; }
        .stat-lbl { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; color: #94a3b8; font-weight: 700; }
        .animate-up { animation: slideUp 0.6s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes slideUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
        .modal-overlay { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.95); z-index: 50; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal-content { background: #1e293b; width: 95%; max-width: 1000px; max-height: 90vh; border-radius: 16px; border: 1px solid #475569; display: flex; flex-direction: column; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); }
        #pdf-report-container { background: white; color: black; padding: 40px; font-family: sans-serif; }
        .pdf-page { min-height: 950px; padding: 20px; page-break-after: always; position: relative; }
        .pdf-page:last-child { page-break-after: avoid; }
        .pdf-header { border-bottom: 3px solid #84cc16; padding-bottom: 15px; margin-bottom: 30px; display: flex; justify-content: space-between; align-items: flex-end; }
        .pdf-logo { font-size: 28px; font-weight: 900; color: #0f172a; }
        .pdf-meta { text-align: right; font-size: 10px; color: #64748b; }
        .pdf-table { width: 100%; border-collapse: collapse; font-size: 11px; margin-bottom: 20px; }
        .pdf-table th { background: #0f172a; color: white; padding: 8px; text-align: left; font-weight: bold; text-transform: uppercase; }
        .pdf-table td { border-bottom: 1px solid #cbd5e1; padding: 8px 6px; color: #334155; }
        .pdf-table tr:nth-child(even) { background-color: #f8fafc; }
        .pdf-section-title { font-size: 16px; font-weight: 800; color: #15803d; margin-top: 30px; margin-bottom: 15px; text-transform: uppercase; border-left: 6px solid #84cc16; padding-left: 10px; }
    </style>
</head>
<body class="min-h-screen flex flex-col p-4 md:p-8">

    <header class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
        <div>
            <h1 class="text-3xl font-black text-white tracking-tight">JLB <span class="text-[#84cc16]">GROUP</span></h1>
            <p class="text-xs text-slate-400 font-mono mt-1 tracking-widest">BI DASHBOARD PRO</p>
        </div>
        <div class="flex gap-3">
            <button onclick="descargarPDFCompleto()" class="group bg-red-600 hover:bg-red-700 text-white px-6 py-3 rounded-xl text-sm font-bold flex items-center gap-2 transition-all shadow-lg shadow-red-900/20 active:scale-95">
                <i data-lucide="file-down" class="w-5 h-5 group-hover:animate-bounce"></i> INFORME PDF
            </button>
            <button onclick="volverOperacion()" class="bg-[#84cc16] hover:bg-[#65a30d] text-[#0f172a] px-5 py-3 rounded-xl text-sm font-bold flex items-center gap-2 transition-transform active:scale-95">
                <i data-lucide="arrow-left" class="w-5 h-5"></i> OPERACIÓN
            </button>
        </div>
    </header>

    <div id="loader" class="flex-1 flex flex-col items-center justify-center text-slate-500 min-h-[50vh]">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-[#84cc16] mb-6"></div>
        <p class="text-sm font-mono tracking-widest animate-pulse">PROCESANDO DATOS EN TIEMPO REAL...</p>
    </div>

    <main id="dashboard-ui" class="hidden space-y-8 animate-up pb-20">
        
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
            <div class="card border-l-4 border-l-blue-500 group" onclick="abrirModalLista('planta', 'TOTAL EN PLANTA (ACTIVOS)')">
                <div class="stat-val text-white group-hover:text-blue-400 transition-colors" id="kpi-total">-</div>
                <div class="stat-lbl">Total en Planta</div>
                <div class="absolute top-4 right-4 text-blue-500 opacity-20 group-hover:opacity-100 transition-opacity"><i data-lucide="factory" class="w-8 h-8"></i></div>
            </div>
            <div class="card border-l-4 border-l-red-500 bg-red-500/5 group" onclick="abrirModalLista('sinAuth', 'SIN AUTORIZAR / COTIZACIÓN')">
                <div class="stat-val text-red-400 group-hover:text-red-300 transition-colors" id="kpi-sin">-</div>
                <div class="stat-lbl">Sin Autorizar</div>
                <div class="absolute top-4 right-4 text-red-500 opacity-20 group-hover:opacity-100 transition-opacity"><i data-lucide="alert-circle" class="w-8 h-8"></i></div>
            </div>
            <div class="card border-l-4 border-l-green-500 group" onclick="abrirModalLista('listos', 'TERMINADOS EN BODEGA')">
                <div class="stat-val text-green-400 group-hover:text-green-300 transition-colors" id="kpi-listos">-</div>
                <div class="stat-lbl">Listos Entrega</div>
                <div class="absolute top-4 right-4 text-green-500 opacity-20 group-hover:opacity-100 transition-opacity"><i data-lucide="check-circle-2" class="w-8 h-8"></i></div>
            </div>
            <div class="card border-l-4 border-l-purple-500">
                <div class="stat-val text-purple-400" id="kpi-mes">-</div>
                <div class="stat-lbl">Entregas (Mes Actual)</div>
                <div class="absolute top-4 right-4 text-purple-500 opacity-20"><i data-lucide="truck" class="w-8 h-8"></i></div>
            </div>
        </div>

        <h3 class="text-sm font-bold text-slate-400 tracking-wider mt-4 mb-2">TIEMPOS PROMEDIO DE CICLO (ANUAL)</h3>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="bg-yellow-900/10 border border-yellow-700/30 rounded-xl p-4 flex items-center justify-between">
                <div><div class="text-2xl font-black text-yellow-500" id="time-auth">0</div><div class="text-[10px] font-bold text-yellow-700 uppercase">Días Autorización</div></div><i data-lucide="clock" class="w-8 h-8 text-yellow-500/30"></i>
            </div>
            <div class="bg-cyan-900/10 border border-cyan-700/30 rounded-xl p-4 flex items-center justify-between">
                <div><div class="text-2xl font-black text-cyan-500" id="time-prod">0</div><div class="text-[10px] font-bold text-cyan-700 uppercase">Días Producción</div></div><i data-lucide="zap" class="w-8 h-8 text-cyan-500/30"></i>
            </div>
            <div class="bg-indigo-900/10 border border-indigo-700/30 rounded-xl p-4 flex items-center justify-between">
                <div><div class="text-2xl font-black text-indigo-500" id="time-bod">0</div><div class="text-[10px] font-bold text-indigo-700 uppercase">Días Bodega</div></div><i data-lucide="package" class="w-8 h-8 text-indigo-500/30"></i>
            </div>
        </div>

        <h3 class="text-sm font-bold text-slate-400 tracking-wider mt-4 mb-2">DETALLE OPERATIVO</h3>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
             <div class="card border-l-4 border-l-cyan-500 bg-cyan-500/5 group" onclick="abrirModalLista('proceso', 'EQUIPOS EN PROCESO DE PRODUCCIÓN')">
                <div class="stat-val text-cyan-400" id="kpi-proceso">-</div>
                <div class="stat-lbl">En Proceso (Trabajando)</div>
                <div class="absolute top-4 right-4 text-cyan-500 opacity-20"><i data-lucide="hammer" class="w-8 h-8"></i></div>
            </div>
            <div class="card border-l-4 border-l-orange-500 bg-orange-500/5 group" onclick="abrirModalLista('parados', 'EQUIPOS PARADOS / STOP')">
                <div class="stat-val text-orange-400" id="kpi-parados">-</div>
                <div class="stat-lbl">Parados / Stop</div>
                <div class="absolute top-4 right-4 text-orange-500 opacity-20"><i data-lucide="pause-circle" class="w-8 h-8"></i></div>
            </div>
            <div class="card border-l-4 border-l-gray-500 bg-gray-500/5 group" onclick="abrirModalLista('devueltos', 'EQUIPOS NO APROBADOS (DEVOLUCIÓN)')">
                <div class="stat-val text-gray-400" id="kpi-devueltos">-</div>
                <div class="stat-lbl">Devoluciones (No Aprobados)</div>
                <div class="absolute top-4 right-4 text-gray-500 opacity-20"><i data-lucide="x-circle" class="w-8 h-8"></i></div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-2 bg-[#1e293b] border border-slate-700 rounded-2xl p-6 shadow-xl">
                <h3 class="text-sm font-bold text-slate-400 mb-6 flex items-center gap-2 tracking-wider">
                    <i data-lucide="bar-chart-3" class="w-4 h-4 text-blue-500"></i> FLUJO DE ENTREGAS 2025
                </h3>
                <div class="h-64 w-full">
                    <canvas id="chartAnual"></canvas>
                </div>
            </div>

            <div class="space-y-6">
                <div class="bg-[#1e293b] border border-slate-700 rounded-2xl p-6 shadow-xl">
                    <h3 class="text-sm font-bold text-slate-400 mb-4 tracking-wider">ESTADO LOTE ACTUAL</h3>
                    <div class="h-48 relative"><canvas id="chartEstado"></canvas></div>
                </div>
                <div class="bg-yellow-900/10 border border-yellow-700/30 rounded-2xl p-0 overflow-hidden cursor-pointer hover:border-yellow-500/50 transition-colors" onclick="abrirModalLista('aceite', 'PENDIENTES ACEITE')">
                    <div class="p-4 border-b border-yellow-700/30 flex justify-between items-center">
                        <h3 class="text-sm font-bold text-yellow-500 flex items-center gap-2"><i data-lucide="droplet" class="w-4 h-4"></i> PENDIENTES ACEITE</h3>
                        <i data-lucide="chevron-right" class="w-4 h-4 text-yellow-700"></i>
                    </div>
                    <div class="p-4"><div id="preview-aceite" class="text-xs text-slate-400 space-y-2"></div></div>
                </div>
            </div>
        </div>

        <div class="bg-[#1e293b] border border-slate-700 rounded-2xl p-6 shadow-xl">
            <h3 class="text-sm font-bold text-slate-400 mb-6 flex items-center gap-2 tracking-wider">
                <i data-lucide="trending-up" class="w-4 h-4 text-cyan-500"></i> TENDENCIA DE TIEMPOS (DÍAS) MES A MES
            </h3>
            <div class="h-64 w-full">
                <canvas id="chartTiempos"></canvas>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="bg-red-950/20 border border-red-900/50 rounded-2xl overflow-hidden">
                <div class="p-4 border-b border-red-900/30 flex items-center justify-between">
                    <h3 class="text-sm font-bold text-red-400 flex items-center gap-2"><i data-lucide="siren" class="w-4 h-4"></i> CRÍTICOS (VENCIDOS)</h3>
                </div>
                <div class="overflow-x-auto"><table class="w-full text-left text-sm text-slate-300"><thead class="bg-red-950/40 text-xs uppercase text-red-300"><tr><th class="p-3">ID</th><th class="p-3">Cliente</th><th class="p-3 text-right">Días</th></tr></thead><tbody id="table-criticos"></tbody></table></div>
            </div>
            <div class="bg-orange-950/20 border border-orange-900/50 rounded-2xl overflow-hidden">
                <div class="p-4 border-b border-orange-900/30 flex items-center justify-between">
                    <h3 class="text-sm font-bold text-orange-400 flex items-center gap-2"><i data-lucide="hourglass" class="w-4 h-4"></i> MAYOR ANTIGÜEDAD</h3>
                </div>
                <div class="overflow-x-auto"><table class="w-full text-left text-sm text-slate-300"><thead class="bg-orange-950/40 text-xs uppercase text-orange-300"><tr><th class="p-3">ID</th><th class="p-3">Cliente</th><th class="p-3 text-right">Días</th></tr></thead><tbody id="table-antiguos"></tbody></table></div>
            </div>
        </div>
    </main>

    <div id="pdf-report-container" class="hidden"></div>

    <div id="modal-detalle" class="modal-overlay" onclick="if(event.target.id==='modal-detalle') this.style.display='none'">
        <div class="modal-content animate-up">
            <div class="p-5 border-b border-slate-700 flex justify-between items-center bg-slate-800 rounded-t-2xl">
                <div><h2 id="modal-titulo" class="text-xl font-bold text-white tracking-tight">DETALLE</h2><p class="text-xs text-slate-400 mt-1">Info Real</p></div>
                <button onclick="document.getElementById('modal-detalle').style.display='none'" class="text-slate-400 hover:text-white"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>
            <div class="p-0 overflow-y-auto flex-1 bg-slate-900/50">
                <table class="w-full text-left text-sm text-slate-300">
                    <thead class="bg-slate-950 text-xs uppercase text-slate-500 sticky top-0 shadow-md"><tr><th class="p-4">ID</th><th class="p-4">Cliente</th><th class="p-4">Desc</th><th class="p-4">Detalle</th><th class="p-4 text-center">Estado</th></tr></thead>
                    <tbody id="modal-body" class="divide-y divide-slate-800/50"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script src="app.js"></script>
    <script>
        lucide.createIcons();
        let chartAnual, chartEstado, chartTiempos;
        let DATA_GLOBAL = null;
        const MESES = ['ENE','FEB','MAR','ABR','MAY','JUN','JUL','AGO','SEP','OCT','NOV','DIC'];

        window.onload = function() {
            google.script.run
                .withSuccessHandler(renderizarDashboard)
                .withFailureHandler(e => document.getElementById('loader').innerHTML = `<p class="text-red-500 font-bold">${e}</p>`)
                .function obtenerDataDashboardBlindado_V36();
        };

        function volverOperacion() { google.script.run.withSuccessHandler(u => window.open(u, '_top')).getScriptUrl(); }

        function renderizarDashboard(data) {
            DATA_GLOBAL = data;
            if(data.error) { alert(data.error); return; }

            // KPI ANIMATIONS
            animateValue("kpi-total", 0, data.listas.planta.length, 1000);
            animateValue("kpi-sin", 0, data.listas.sinAuth.length, 1000);
            animateValue("kpi-listos", 0, data.listas.listos.length, 1000);
            animateValue("kpi-mes", 0, data.kpis.entregadosMes, 1000);
            animateValue("kpi-proceso", 0, data.listas.proceso.length, 1000);
            animateValue("kpi-parados", 0, data.listas.parados.length, 1000);
            animateValue("kpi-devueltos", 0, data.listas.devueltos.length, 1000);
            animateValue("time-auth", 0, data.kpis.tiempoAuth, 1200);
            animateValue("time-prod", 0, data.kpis.tiempoProd, 1200);
            animateValue("time-bod", 0, data.kpis.tiempoBodega, 1200);

            // ACEITE
            const divAceite = document.getElementById('preview-aceite');
            divAceite.innerHTML = data.listas.aceite.length === 0 ? '<p class="italic opacity-50">Sin pendientes</p>' : 
                data.listas.aceite.slice(0,3).map(i => `<div class="flex justify-between border-b border-yellow-800/20 pb-1"><span class="font-bold text-yellow-100">${i.cliente}</span><span class="font-mono text-yellow-600">${i.id}</span></div>`).join('') + (data.listas.aceite.length > 3 ? `<p class="text-[10px] text-center mt-1">+${data.listas.aceite.length-3} más...</p>` : '');

            // TABLAS
            const tc = document.getElementById('table-criticos'); tc.innerHTML = '';
            data.trafosCriticos.slice(0,5).forEach(t => tc.innerHTML += `<tr><td class="p-3 font-mono text-red-300">${t.id}</td><td class="p-3 truncate max-w-[120px]">${t.cliente}</td><td class="p-3 font-bold text-red-500 text-right">${t.diasRetraso} días</td></tr>`);
            
            const ta = document.getElementById('table-antiguos'); ta.innerHTML = '';
            data.topAntiguos.slice(0,5).forEach(t => ta.innerHTML += `<tr><td class="p-3 font-mono text-orange-200">${t.id}</td><td class="p-3 truncate max-w-[120px]">${t.cliente}</td><td class="p-3 text-right">${t.dias} días</td></tr>`);

            renderCharts(data);
            document.getElementById('loader').classList.add('hidden');
            document.getElementById('dashboard-ui').classList.remove('hidden');
            lucide.createIcons();
        }

        function abrirModalMes(indexMes) {
            if(!DATA_GLOBAL) return;
            const lista = DATA_GLOBAL.entregasPorMes[indexMes];
            const tbody = document.getElementById('modal-body'); tbody.innerHTML = '';
            document.getElementById('modal-titulo').innerText = `ENTREGAS ${MESES[indexMes]}`;
            if(lista.length === 0) tbody.innerHTML = '<tr><td colspan="5" class="p-8 text-center text-slate-500">Sin entregas.</td></tr>';
            else lista.forEach(i => tbody.innerHTML += `<tr><td class="p-4 font-mono text-green-400">${i.id}</td><td class="p-4 font-bold text-slate-200">${i.cliente}</td><td class="p-4 text-slate-400 text-xs">${i.desc}</td><td class="p-4 text-xs">Auth: ${i.tAuth}d | Prod: ${i.tProd}d | Bod: ${i.tBod}d</td><td class="p-4 text-center"><span class="bg-purple-900 text-purple-300 px-2 py-1 rounded text-[10px]">ENTREGADO</span></td></tr>`);
            document.getElementById('modal-detalle').style.display = 'flex';
        }

        function abrirModalLista(tipo, titulo) {
            if(!DATA_GLOBAL) return;
            const lista = DATA_GLOBAL.listas[tipo];
            const tbody = document.getElementById('modal-body'); tbody.innerHTML = '';
            document.getElementById('modal-titulo').innerText = titulo;
            if(lista.length === 0) tbody.innerHTML = '<tr><td colspan="5" class="p-8 text-center text-slate-500">Sin registros.</td></tr>';
            else lista.forEach(i => tbody.innerHTML += `<tr><td class="p-4 font-mono text-orange-400">${i.id}</td><td class="p-4 font-bold text-slate-200">${i.cliente}</td><td class="p-4 text-slate-400 text-xs">${i.desc}</td><td class="p-4 text-xs">Ingreso: ${i.fecha} (${i.dias}d)</td><td class="p-4 text-center"><span class="bg-slate-700 px-2 py-1 rounded text-[10px]">${i.estado}</span></td></tr>`);
            document.getElementById('modal-detalle').style.display = 'flex';
        }

        function renderCharts(d) {
            Chart.defaults.color = '#64748b'; Chart.defaults.font.family = 'Inter';
            
            // 1. ENTREGAS (BARRAS)
            if(chartAnual) chartAnual.destroy();
            chartAnual = new Chart(document.getElementById('chartAnual'), {
                type: 'bar',
                data: { labels: MESES, datasets: [{ label: 'Entregas', data: d.graficaAnual, backgroundColor: '#3b82f6', borderRadius: 4 }] },
                options: { responsive: true, maintainAspectRatio: false, scales: { x: { grid: { display:false } }, y: { grid: { color:'#334155' } } }, onClick: (e) => { const p = chartAnual.getElementsAtEventForMode(e,'nearest',{intersect:true},true); if(p.length) abrirModalMes(p[0].index); } }
            });

            // 2. ESTADO (DONA)
            if(chartEstado) chartEstado.destroy();
            chartEstado = new Chart(document.getElementById('chartEstado'), {
                type: 'doughnut',
                data: { labels: ['Pendiente','Proceso','Listo','Parado','Devuelto'], datasets: [{ data: [d.listas.sinAuth.length, d.listas.proceso.length, d.listas.listos.length, d.listas.parados.length, d.listas.devueltos.length], backgroundColor: ['#ef4444','#3b82f6','#22c55e','#f97316','#64748b'], borderWidth:0 }] },
                options: { responsive: true, maintainAspectRatio: false, cutout: '75%', plugins: { legend: { position:'right', labels:{color:'#cbd5e1', usePointStyle:true} } } }
            });

            // 3. TIEMPOS (LINEAS) - NUEVA
            if(chartTiempos) chartTiempos.destroy();
            chartTiempos = new Chart(document.getElementById('chartTiempos'), {
                type: 'line',
                data: {
                    labels: MESES,
                    datasets: [
                        { label: 'Autorización', data: d.tiemposMes.map(x=>x.auth), borderColor: '#eab308', backgroundColor: '#eab308', tension: 0.4 },
                        { label: 'Producción', data: d.tiemposMes.map(x=>x.prod), borderColor: '#06b6d4', backgroundColor: '#06b6d4', tension: 0.4 },
                        { label: 'Bodega', data: d.tiemposMes.map(x=>x.bod), borderColor: '#6366f1', backgroundColor: '#6366f1', tension: 0.4 }
                    ]
                },
                options: { 
                    responsive: true, maintainAspectRatio: false, 
                    plugins: { legend: { position: 'top', labels: { color: '#cbd5e1' } } },
                    scales: { y: { grid: { color: '#334155' }, title: { display:true, text:'Días Promedio' } }, x: { grid: { display: false } } }
                }
            });
        }

        function animateValue(id,s,e,d){if(s===e){document.getElementById(id).innerHTML=e;return}const r=e-s;let c=s;const inc=e>s?1:-1;const t=Math.abs(Math.floor(d/r));const o=document.getElementById(id);const tm=setInterval(()=>{c+=inc;o.innerHTML=c;if(c==e)clearInterval(tm)},t>0?t:10);}

        async function descargarPDFCompleto() {
            if(!DATA_GLOBAL) return;
            const btn = document.querySelector('button[onclick="descargarPDFCompleto()"]');
            const originalHTML = btn.innerHTML; btn.innerHTML = '⏳ GENERANDO...'; btn.disabled = true;
            const c = document.getElementById('pdf-report-container'); c.classList.remove('hidden'); c.innerHTML = '';
            const hoy = new Date().toLocaleDateString();
            const img1 = document.getElementById('chartAnual').toDataURL('image/png');
            const img3 = document.getElementById('chartTiempos').toDataURL('image/png'); // Imagen de Tiempos

            // PDF PÁGINA 1
            c.innerHTML += `
                <div class="pdf-page">
                    <div class="pdf-header"><div><div class="pdf-logo">JLB GROUP</div><div>Reporte Gerencial</div></div><div class="pdf-meta">${hoy}</div></div>
                    <div style="display:grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 20px;">
                        <div style="background:#f1f5f9; padding:15px; border-left:4px solid #3b82f6; text-align:center;"><div style="font-size:24px; font-weight:900;">${DATA_GLOBAL.listas.planta.length}</div><div style="font-size:10px;">EN PLANTA</div></div>
                        <div style="background:#fef2f2; padding:15px; border-left:4px solid #ef4444; text-align:center;"><div style="font-size:24px; font-weight:900;">${DATA_GLOBAL.listas.sinAuth.length}</div><div style="font-size:10px;">SIN AUTH</div></div>
                        <div style="background:#f0fdf4; padding:15px; border-left:4px solid #22c55e; text-align:center;"><div style="font-size:24px; font-weight:900;">${DATA_GLOBAL.listas.listos.length}</div><div style="font-size:10px;">LISTOS</div></div>
                        <div style="background:#fff7ed; padding:15px; border-left:4px solid #f97316; text-align:center;"><div style="font-size:24px; font-weight:900;">${DATA_GLOBAL.listas.parados.length}</div><div style="font-size:10px;">PARADOS</div></div>
                    </div>
                    <div style="display:grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px;">
                        <div style="border:1px solid #ca8a04; padding:10px; text-align:center;"><div style="font-size:18px; font-weight:bold; color:#ca8a04;">${DATA_GLOBAL.kpis.tiempoAuth} Días</div><div style="font-size:9px;">AVG AUTORIZACIÓN</div></div>
                        <div style="border:1px solid #0891b2; padding:10px; text-align:center;"><div style="font-size:18px; font-weight:bold; color:#0891b2;">${DATA_GLOBAL.kpis.tiempoProd} Días</div><div style="font-size:9px;">AVG PRODUCCIÓN</div></div>
                        <div style="border:1px solid #4f46e5; padding:10px; text-align:center;"><div style="font-size:18px; font-weight:bold; color:#4f46e5;">${DATA_GLOBAL.kpis.tiempoBodega} Días</div><div style="font-size:9px;">AVG BODEGAJE</div></div>
                    </div>
                    <div class="pdf-section-title" style="color:#06b6d4; border-color:#06b6d4;">TENDENCIA DE TIEMPOS</div>
                    <div style="text-align:center; margin-bottom:20px;"><img src="${img3}" style="width:100%; height:200px; object-fit:contain;"></div>
                    <div class="pdf-section-title" style="color:#3b82f6; border-color:#3b82f6;">ENTREGAS POR MES</div>
                    <div style="text-align:center;"><img src="${img1}" style="width:100%; height:200px; object-fit:contain;"></div>
                </div>
            `;
            
            // PDF PÁGINA 2: DETALLE
            let rows = ''; DATA_GLOBAL.topAntiguos.forEach(i => rows += `<tr><td>${i.id}</td><td>${i.cliente}</td><td>${i.desc.substring(0,30)}</td><td>${i.fecha}</td><td>${i.dias}</td><td>${i.estado}</td></tr>`);
            c.innerHTML += `<div class="pdf-page"><div class="pdf-header"><div class="pdf-logo">INVENTARIO</div></div><table class="pdf-table"><thead><tr><th>ID</th><th>CLIENTE</th><th>DESC</th><th>INGRESO</th><th>DIAS</th><th>ESTADO</th></tr></thead><tbody>${rows}</tbody></table></div>`;

            try { await html2pdf().set({ margin:0, filename:`JLB_Informe_${hoy}.pdf`, image:{type:'jpeg',quality:0.98}, html2canvas:{scale:2, useCORS:true}, jsPDF:{unit:'mm',format:'a4'} }).from(c).save(); } catch(e){ alert(e); } finally { c.classList.add('hidden'); c.innerHTML=''; btn.innerHTML=originalHTML; btn.disabled=false; }
        }
    </script>
</body>
</html>
